# =============================================================================
# GitHub Actions Workflow: EKS Auto Mode - Production Platform
# =============================================================================
# Per ADR-013: Uses OIDC federation to assume IAM role for Terraform operations
# Per ADR-014: Requires approval for all operations in production
#
# Triggers:
#   - Push to main: Plan only (requires manual approval to apply)
#   - Pull request: Plan only with PR comment
#   - Manual: Plan, Apply, or Destroy via workflow_dispatch
#
# Production Safety:
#   - No TTL/auto-destroy (production clusters are persistent)
#   - Requires approval for apply AND destroy
#   - Extra confirmation step before destructive operations
# =============================================================================

name: "Terraform: Production Platform EKS"

on:
  push:
    branches:
      - main
    paths:
      - "terraform/env-production/platform-layer/eks-auto-mode/**"
      - ".github/workflows/terraform-prod-platform-eks.yml"

  pull_request:
    branches:
      - main
    paths:
      - "terraform/env-production/platform-layer/eks-auto-mode/**"
      - ".github/workflows/terraform-prod-platform-eks.yml"

  workflow_dispatch:
    inputs:
      action:
        description: "Terraform action to perform"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy
      confirm_production:
        description: "Type 'PRODUCTION' to confirm production changes"
        required: false
        type: string

# Ensure only one workflow runs at a time for this environment
concurrency:
  group: terraform-prod-platform-eks
  cancel-in-progress: false

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # ===========================================================================
  # Determine Action Based on Trigger
  # ===========================================================================
  determine-action:
    name: "Determine Action"
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.set-action.outputs.action }}
      should_run: ${{ steps.set-action.outputs.should_run }}
    steps:
      - name: Determine action based on trigger
        id: set-action
        run: |
          ACTION="plan"
          SHOULD_RUN="true"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ACTION="${{ github.event.inputs.action }}"
            
            # Require confirmation for apply/destroy in production
            if [[ "$ACTION" != "plan" ]]; then
              if [[ "${{ github.event.inputs.confirm_production }}" != "PRODUCTION" ]]; then
                echo "❌ Production confirmation required. Please type 'PRODUCTION' to confirm." >> $GITHUB_STEP_SUMMARY
                SHOULD_RUN="false"
              fi
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Production only plans on push, never auto-applies
            ACTION="plan"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            ACTION="plan"
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "Determined action: $ACTION"

  # ===========================================================================
  # Production Confirmation Gate
  # ===========================================================================
  confirm-production:
    name: "Confirm Production"
    runs-on: ubuntu-latest
    needs: determine-action
    if: |
      needs.determine-action.outputs.should_run == 'false'
    steps:
      - name: Fail - Production confirmation required
        run: |
          echo "## ❌ Production Confirmation Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To perform **${{ needs.determine-action.outputs.action }}** in production:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Re-run this workflow manually" >> $GITHUB_STEP_SUMMARY
          echo "2. Type \`PRODUCTION\` in the confirmation field" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is a safety measure to prevent accidental production changes." >> $GITHUB_STEP_SUMMARY
          exit 1

  # ===========================================================================
  # Call Reusable Terraform EKS Workflow
  # ===========================================================================
  terraform:
    name: "Terraform"
    needs: determine-action
    if: needs.determine-action.outputs.should_run == 'true'
    uses: ./.github/workflows/reusable-terraform-eks.yml
    with:
      environment: production
      action: ${{ needs.determine-action.outputs.action }}
      ttl_hours: "0"  # Production clusters never auto-destroy
      working_directory: terraform/env-production/platform-layer/eks-auto-mode
      tf_workspace: production-platform-eks
      require_approval: true  # Production always requires approval
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN_PROD_PLATFORM }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

  # ===========================================================================
  # Drift Detection (PR only - Per ADR-020)
  # ===========================================================================
  drift-detection:
    name: "Drift Detection"
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/eks-drift-detection.yml
    with:
      fail_on_drift: false  # Don't fail PR, just report
      reference_environment: development

  # ===========================================================================
  # Sync 1Password (Per ADR-017: Lifecycle Coordination)
  # ===========================================================================
  sync-1password:
    name: "Sync 1Password"
    needs: [determine-action, terraform]
    if: |
      always() &&
      (needs.terraform.result == 'success') &&
      (needs.determine-action.outputs.action == 'apply' || needs.determine-action.outputs.action == 'destroy')
    uses: ./.github/workflows/reusable-1password-eks-sync.yml
    with:
      environment: production
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
