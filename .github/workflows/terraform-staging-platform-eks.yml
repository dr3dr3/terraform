# =============================================================================
# GitHub Actions Workflow: EKS Auto Mode - Staging Platform
# =============================================================================
# Per ADR-013: Uses OIDC federation to assume IAM role for Terraform operations
# Per ADR-014: Requires approval for apply operations in staging
#
# Triggers:
#   - Push to main: Plan only (requires manual approval to apply)
#   - Pull request: Plan only with PR comment
#   - Manual: Plan, Apply, or Destroy via workflow_dispatch
# =============================================================================

name: "Terraform: Staging Platform EKS"

on:
  push:
    branches:
      - main
    paths:
      - "terraform/env-staging/platform-layer/eks-auto-mode/**"
      - ".github/workflows/terraform-staging-platform-eks.yml"

  pull_request:
    branches:
      - main
    paths:
      - "terraform/env-staging/platform-layer/eks-auto-mode/**"
      - ".github/workflows/terraform-staging-platform-eks.yml"

  workflow_dispatch:
    inputs:
      action:
        description: "Terraform action to perform"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy
      ttl_hours:
        description: "Time-to-live in hours (0 = no auto-destroy)"
        required: false
        default: "48"
        type: string

# Ensure only one workflow runs at a time for this environment
concurrency:
  group: terraform-staging-platform-eks
  cancel-in-progress: false

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # ===========================================================================
  # Determine Action Based on Trigger
  # ===========================================================================
  determine-action:
    name: "Determine Action"
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.set-action.outputs.action }}
      ttl_hours: ${{ steps.set-action.outputs.ttl_hours }}
    steps:
      - name: Determine action based on trigger
        id: set-action
        run: |
          ACTION="plan"
          TTL_HOURS="48"  # Staging default: 48 hours

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ACTION="${{ github.event.inputs.action }}"
            if [[ -n "${{ github.event.inputs.ttl_hours }}" ]]; then
              TTL_HOURS="${{ github.event.inputs.ttl_hours }}"
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Staging requires manual approval, so only plan on push
            ACTION="plan"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            ACTION="plan"
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "ttl_hours=$TTL_HOURS" >> $GITHUB_OUTPUT
          echo "Determined action: $ACTION with TTL: ${TTL_HOURS}h"

  # ===========================================================================
  # Call Reusable Terraform EKS Workflow
  # ===========================================================================
  terraform:
    name: "Terraform"
    needs: determine-action
    uses: ./.github/workflows/reusable-terraform-eks.yml
    with:
      environment: staging
      action: ${{ needs.determine-action.outputs.action }}
      ttl_hours: ${{ needs.determine-action.outputs.ttl_hours }}
      working_directory: terraform/env-staging/platform-layer/eks-auto-mode
      tf_workspace: staging-platform-eks
      require_approval: true  # Staging requires approval
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN_STAGING_PLATFORM }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

  # ===========================================================================
  # Drift Detection (PR only - Per ADR-020)
  # ===========================================================================
  drift-detection:
    name: "Drift Detection"
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/eks-drift-detection.yml
    with:
      fail_on_drift: false  # Don't fail PR, just report
      reference_environment: development
    secrets: inherit

  # ===========================================================================
  # Sync 1Password (Per ADR-017: Lifecycle Coordination)
  # ===========================================================================
  sync-1password:
    name: "Sync 1Password"
    needs: [determine-action, terraform]
    if: |
      always() &&
      (needs.terraform.result == 'success') &&
      (needs.determine-action.outputs.action == 'apply' || needs.determine-action.outputs.action == 'destroy')
    uses: ./.github/workflows/reusable-1password-eks-sync.yml
    with:
      environment: staging
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
