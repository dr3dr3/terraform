# =============================================================================
# GitHub Actions Workflow: Reusable 1Password EKS Sync
# =============================================================================
# Per ADR-017: Terraform-Managed Lifecycle with Conditional Resources
#
# This reusable workflow syncs EKS cluster details to 1Password after any
# EKS lifecycle operation (create, update, destroy, TTL-based cleanup).
#
# How it works:
# 1. Runs eks-cluster-admin Terraform configuration
# 2. Terraform checks if EKS cluster exists via TFC outputs
# 3. If cluster exists: Creates/updates 1Password secure note
# 4. If cluster gone: Destroys 1Password item (count = 0)
#
# This approach ensures:
# - 1Password items are created when EKS clusters are provisioned
# - 1Password items are automatically cleaned up when clusters are destroyed
# - TTL-based auto-destroy triggers 1Password cleanup
# - State is managed by Terraform (idempotent, self-healing)
# =============================================================================

name: "Reusable: Sync EKS to 1Password"

run-name: "ðŸ” Sync ${{ inputs.environment }} EKS to 1Password [${{ github.run_id }}]"

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (development, staging, production, sandbox)"
        required: true
        type: string
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN:
        description: "1Password Service Account Token for CLI authentication"
        required: true
      TF_API_TOKEN:
        description: "Terraform Cloud API token"
        required: true

jobs:
  sync:
    name: "Sync 1Password"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Verify 1Password CLI
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          op --version
          op whoami

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: terraform/env-management/foundation-layer/eks-1password
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform/env-management/foundation-layer/eks-1password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          TF_VAR_onepassword_service_account_token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "## 1Password Sync ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Syncing EKS cluster details for **${{ inputs.environment }}** environment..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Set the sync variable for the target environment
          case "${{ inputs.environment }}" in
            development)
              SYNC_VAR="-var=sync_development_eks=true"
              ;;
            staging)
              SYNC_VAR="-var=sync_staging_eks=true"
              ;;
            production)
              SYNC_VAR="-var=sync_production_eks=true"
              ;;
            sandbox)
              SYNC_VAR="-var=sync_sandbox_eks=true"
              ;;
            *)
              echo "âŒ Unknown environment: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
              exit 1
              ;;
          esac

          # Run terraform apply
          # - If cluster exists: Creates/updates 1Password item
          # - If cluster gone: Destroys 1Password item (count = 0)
          terraform apply -auto-approve -input=false $SYNC_VAR

      - name: Summary
        working-directory: terraform/env-management/foundation-layer/eks-1password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check what 1Password items exist for this environment
          ITEMS=$(op item list --vault terraform --format json 2>/dev/null | \
            jq -r ".[] | select(.title | startswith(\"EKS-${{ inputs.environment }}-\")) | .title" || echo "")

          if [[ -n "$ITEMS" ]]; then
            echo "âœ… **1Password items for ${{ inputs.environment }}:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r item; do
              echo "- \`$item\`" >> $GITHUB_STEP_SUMMARY
            done <<< "$ITEMS"
          else
            echo "â„¹ï¸ No 1Password items found for ${{ inputs.environment }} environment." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This is expected if the EKS cluster has been destroyed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Synced by: \`${{ github.workflow }}\` | Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> $GITHUB_STEP_SUMMARY
